<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data noupdate="0">
<!-- Edit assets template to replace website_sale_payment.js with a  modified one to validate transaction number and other details entered by user-->
<template id="mobilem_assets_frontend" inherit_id="website_sale.assets_frontend" name="Mpesa">
  <xpath expr="//script[contains(@src,'website_sale_payment.js')]" position="replace">
      <script type="text/javascript" src="/payment_mobilem/static/src/js/website_sale_payment.js"></script>
  </xpath>
</template>
<!-- Modify payment template to display image logo for each payment aquirer-->
<template id="mobilem_aquirer_inherit" inherit_id="website_sale.payment" name="Mobilem inherited payment">
  <xpath expr="//img[contains(@t-att-src,'_icon.png')]" position="replace">
  </xpath>
  <xpath expr="//input[@name = 'acquirer']" position="after">
    <t t-if="acquirer.image">
	<span itemprop="image" t-att-title="acquirer.name" t-field="acquirer.image" 
		t-field-options='{"widget": "image", "class": "media-object", "style": "width: 60px; display: inline-block;"}'/>
    </t>
    <t t-if="not acquirer.image">
	<img class="media-object" style="width: 60px; display: inline-block;"
                t-att-title="acquirer.name"
                t-att-src="'/payment_%s/static/src/img/%s_icon.png' % (acquirer.provider, acquirer.provider)"/>
    </t>
  </xpath>
</template>
<!-- The template for mobilem acquirer button-->
        <template id="mobilem_acquirer_button">
            <form t-if="acquirer" t-att-action="tx_url" method="post" target="_self" id="MobilemForm">
		<input id="csrf_token" type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                <t t-if="return_url">
                    <input id="return_url" type='hidden' name='return_url' t-att-value='return_url'/>
                </t>
		<t t-if="acquirer.mobilem_account_id">
		  <div>
		   <table class="table table-striped table-condensed">
		     <tbody>
		      <tr>
			<td>
			  <span><t t-esc="acquirer.mobilem_service_type"/>:</span>
			</td>
			<td class="text-right">
			  <strong><span><t t-esc="acquirer.mobilem_service_number"/></span></strong>
			</td>
		      </tr>
		      <tr>
			<td>
			  <span>Amount To Pay:</span>
			</td>
			<td class="text-right">
			  <strong><span><t t-esc="acquirer.mobilem_currency_id.symbol"/></span> <t t-esc="'{:,.2f}'.format((amount / currency.rate) * acquirer.mobilem_currency_id.rate)"/></strong>
			</td>
		      </tr>      
		      <tr>
			<td>
			  <span>Order Number:</span>
			</td>
			<td class="text-right">
			  <strong><span><t t-esc="reference"/></span></strong>
			</td>
		      </tr>      
		    </tbody>
		  </table>
		 </div>
		</t>
                <t t-if="acquirer.mobilem_account_id">
		   <div>Transaction Number<input type='text' name='confirm_code' id="confirm_code"/></div>
                </t>
		<!--<p>Once you have finished making your payment, please click on the button below to submit the transaction number and confirm your payment. 
                    You will receive SMS notification within few minutes</p> -->
                <input id="reference" type='hidden' name='reference' t-att-value='reference'/>
                <input id="amount" type='hidden' name='amount' t-att-value='amount or "0.0"'/>
                <input id="currency" type='hidden' name='currency' t-att-value='currency.name'/>
                <input id="acquirer" type='hidden' name='acquirer' t-att-value='acquirer.id'/>
                <!-- submit -->
                <p/><button id="mobilem_submit" name="mobilem_submit" type="submit" width="100px"
                    t-att-class="submit_class">
                    <img t-if="not submit_txt" src="/payment_mobilem/static/src/img/mobilem_icon.png"/>
                    <span t-if="submit_txt">Confirm Payment <span class="fa fa-long-arrow-right"/></span>
                </button><p/>
            </form>
        </template>
	<template id="web_portal_invoice_inherit" inherit_id="website_portal_sale.invoices" name="Invoices and Payments Inherited">
             <xpath expr="//table//thead//tr[@class='active']" position="replace">
		<tr class="active">
                    <th>Invoice #</th>
                    <th>Invoice Date</th>
                    <th>Due Date</th>
                    <th>Order#</th>
                    <th></th>
                    <th></th>
                    <th>Total</th>
                  </tr>
             </xpath>
             <xpath expr="//table//tr[contains(@t-att-class, 'invoice_index')]" position="replace">
                    <tr t-att-class="'hidden to_hide' if invoice.state!='open' and invoice_index &gt; 4 else ''">
                        <td>
                            <a t-att-href="'/report/pdf/account.report_invoice/'+str(invoice.id)"> <t  t-esc="{}.format(invoice.number)"/> </a>
                        </td>
                        <td > <span style="padding-left: 8px;" t-field="invoice.date_invoice"/> </td>
                        <td><span t-field="invoice.date_due"/></td>
                        <td><span t-field="invoice.origin"/></td>
                        <td>
                            <t t-if="invoice.state == 'open'">
                                <span class="label label-info"><i class="fa fa-fw fa-clock-o"/> Waiting for Payment</span>
                            </t>
                            <t t-if="invoice.state == 'paid'">
                                <span class="label label-default"><i class="fa fa-fw fa-check"/> Paid</span>
                            </t>
                            <t t-if="invoice.state == 'cancel'">
                                <span class="label label-default"><i class="fa fa-fw fa-remove"/> Cancelled</span>
                            </t>
                        </td>
                        <td>
                          <a t-if="invoice.state == 'open'" t-attf-href="/website_payment/pay?reference=#{invoice.number}&amp;amount=#{invoice.amount_total}&amp;currency_id=#{invoice.currency_id.id}&amp;country_id=#{invoice.partner_id.country_id.id}" alt="Pay Now" class="btn btn-xs btn-primary"><i class="fa fa-arrow-circle-right"/> Pay Now</a>
                        </td>
                        <td><span t-esc="invoice.amount_total" t-esc-options='{"widget": "monetary", "display_currency": "invoice.currency_id"}'/></td>
                    </tr>
	     </xpath>
	</template>
    </data>
</openerp>

